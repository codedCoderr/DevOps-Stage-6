name: ðŸš€ Application Deployment

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - "auth-api/**"
      - "todos-api/**"
      - "users-api/**"
      - "log-message-processor/**"
      - "docker-compose.yml"
  workflow_dispatch:

jobs:
  deploy_app:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-app
      cancel-in-progress: true

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v3

      # 2. Setup SSH key for Ansible
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          # Decode Base64 private key and set permissions
          echo "${{ vars.SSH_PRIVATE_KEY_BASE64 }}" | base64 --decode > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Dynamically add hosts from inventory.ini to known_hosts
          INVENTORY_FILE=infra/inventory.ini
          grep -vE '^\[|\s*#' "$INVENTORY_FILE" | awk '{print $1}' | while read host; do
            ssh-keyscan -H "$host" >> ~/.ssh/known_hosts || true
          done

      # 3. Run Ansible Deploy Playbook
      - name: Run Ansible Deploy
        working-directory: infra/terraform
        env:
          AUTH_API_ADDRESS: ${{ vars.AUTH_API_ADDRESS }}
          TODOS_API_ADDRESS: ${{ vars.TODOS_API_ADDRESS }}
          USERS_API_ADDRESS: ${{ vars.USERS_API_ADDRESS }}
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          ansible-playbook -i ../inventory.ini ../ansible/deploy.yml --private-key ~/.ssh/id_rsa
