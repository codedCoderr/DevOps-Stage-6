---
- name: Provision and Deploy TODO App
  hosts: webservers
  become: yes # Run tasks with sudo
  vars:
    # Important: Update this to your forked repo URL
    repo_url: https://github.com/codedCoderr/DevOps-Stage-6.git
    app_dir: /opt/todo-app

  pre_tasks:
    # 1. INSTALL DISK UTILS (Required for 'growpart' command)
    - name: Install cloud-guest-utils (contains growpart) on Ubuntu/Debian
      ansible.builtin.apt:
        name: cloud-guest-utils
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install cloud-utils-growpart on RedHat/Amazon Linux
      ansible.builtin.yum:
        name: cloud-utils-growpart
        state: present
      when: ansible_os_family == "RedHat" or ansible_os_family == "Amazon"

    # --- Disk Expansion Logic (Fixed Partition Lookup and Reboot) ---

    # 2. GET DEVICE INFO
    # Determine the real device path (e.g., /dev/xvda1) used for the root filesystem.
    - name: Get real partition path (resolving /dev/root alias)
      ansible.builtin.command: readlink -f /dev/root
      register: readlink_result

    - name: Set real_partition_path fact
      ansible.builtin.set_fact:
        real_partition_path: "{{ readlink_result.stdout }}"

    - name: Set disk_device and partition_num facts (Robustly handle /dev/root ambiguity)
      ansible.builtin.set_fact:
        # If readlink returned '/dev/root', we default to standard EC2 device /dev/xvda and partition 1.
        # Otherwise, we use regex to extract the device and partition number.
        disk_device: "{{ '/dev/xvda' if real_partition_path == '/dev/root' else real_partition_path | regex_replace('[0-9]+$', '') }}"
        partition_num: "{{ '1' if real_partition_path == '/dev/root' else real_partition_path | regex_replace('.*[^0-9]([0-9]+)$', '\\1') }}"

    # 3. EXPAND PARTITION
    - name: Expand root partition using growpart (e.g., growpart /dev/xvda 1)
      ansible.builtin.command: "growpart {{ disk_device }} {{ partition_num }}"
      # Ignore errors because the command fails with a non-zero exit code if partition is already expanded.
      ignore_errors: true
      register: growpart_result

    # 4. REBOOT AND WAIT (Crucial step to ensure kernel recognizes the new partition size)
    - name: Reboot the server to finalize partition size change (if growpart reported a change)
      ansible.builtin.reboot:
        reboot_timeout: 300
      when: growpart_result.rc == 0

    - name: Wait for the server to be ready after reboot
      ansible.builtin.wait_for_connection:
        timeout: 300
        delay: 5
      when: growpart_result.rc == 0

    # 5. EXPAND FILESYSTEM (Must happen after partition expansion and potential reboot)
    - name: Get root filesystem type
      ansible.builtin.set_fact:
        fstype: "{{ ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first }}"

    - name: Resize ext4/ext3 filesystem to fill the expanded partition
      ansible.builtin.command: "resize2fs {{ real_partition_path }}"
      when: fstype in ['ext4', 'ext3']

    - name: Resize xfs filesystem to fill the expanded partition
      ansible.builtin.command: "xfs_growfs /"
      when: fstype == 'xfs'

    # --- End of Disk Expansion Logic ---

  roles:
    - dependencies
    - deploy
