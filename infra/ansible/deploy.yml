---
- name: Provision and Deploy TODO App
  hosts: webservers
  become: yes # Run tasks with sudo
  vars:
    # Important: Update this to your forked repo URL
    repo_url: https://github.com/codedCoderr/DevOps-Stage-6.git
    app_dir: /opt/todo-app

  pre_tasks:
    # 1. INSTALL DISK UTILS
    - name: Install cloud-guest-utils (contains growpart) on Ubuntu/Debian
      ansible.builtin.apt:
        name: cloud-guest-utils
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: Install cloud-utils-growpart on RedHat/Amazon Linux
      ansible.builtin.yum:
        name: cloud-utils-growpart
        state: present
      when: ansible_os_family == "RedHat" or ansible_os_family == "Amazon"

    # --- Disk Expansion Logic (Fixing Jinja error with two-step command) ---

    # 2. GET DEVICE INFO (Robustly find disk and partition number)
    # Task 2a: Use the command module to reliably get the real path (e.g., /dev/xvda1)
    - name: Get real partition path (resolving /dev/root alias)
      ansible.builtin.command: readlink -f /dev/root
      register: readlink_result

    - name: Set real_partition_path fact
      ansible.builtin.set_fact:
        # The actual path (e.g., /dev/xvda1) is in the stdout of the command
        real_partition_path: "{{ readlink_result.stdout }}"

    - name: Set disk_device and partition_num facts
      ansible.builtin.set_fact:
        # disk_device: Path minus the trailing digit (e.g., /dev/xvda from /dev/xvda1)
        disk_device: "{{ real_partition_path | regex_replace('[0-9]+$', '') }}"
        # partition_num: The trailing digit (e.g., 1 from /dev/xvda1)
        partition_num: "{{ real_partition_path | regex_replace('.*[^0-9]([0-9]+)$', '\\1') }}"

    # 3. EXPAND PARTITION
    - name: Expand root partition using growpart (uses {{ disk_device }} and {{ partition_num }})
      ansible.builtin.command: "growpart {{ disk_device }} {{ partition_num }}"
      # The growpart command will only fail if it's already expanded or the arguments are wrong.
      # If it's already expanded, it exits non-zero, so we use ignore_errors.
      ignore_errors: true

    # 4. EXPAND FILESYSTEM
    - name: Get root filesystem type
      ansible.builtin.set_fact:
        fstype: "{{ ansible_facts['mounts'] | selectattr('mount', 'equalto', '/') | map(attribute='fstype') | first }}"

    - name: Resize ext4/ext3 filesystem to fill the expanded partition
      ansible.builtin.command: "resize2fs {{ real_partition_path }}"
      when: fstype in ['ext4', 'ext3']

    - name: Resize xfs filesystem to fill the expanded partition
      ansible.builtin.command: "xfs_growfs /"
      when: fstype == 'xfs'

    # --- End of Disk Expansion Logic ---

  roles:
    - dependencies
    - deploy
