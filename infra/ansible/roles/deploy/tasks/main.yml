---
- name: Clone or update application repository (Idempotent Git checkout)
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    clone: yes
    update: yes
    force: yes
  register: git_pull_result

- name: Create Traefik acme.json file with correct permissions (Required for ACME/LetsEncrypt)
  ansible.builtin.file:
    path: "{{ app_dir }}/acme.json"
    state: touch
    mode: "0600"
    owner: root
    group: root

- name: Clean up unused Docker resources (Freeing disk space to resolve 'no space left' error)
  become: yes
  community.docker.docker_prune:
    containers: yes
    images: yes
    volumes: yes
    networks: yes

- name: Start/Restart all services with docker-compose (Only if repo content changed)
  become: yes
  become_user: root
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    state: present
  when: git_pull_result.changed or inventory_hostname is defined
