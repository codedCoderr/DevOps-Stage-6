---
# 1. Clone/update the repository (optional, needed only for docker-compose.yml or configs)
- name: Clone or update application repository
  ansible.builtin.git:
    repo: "{{ repo_url }}"
    dest: "{{ app_dir }}"
    clone: yes
    update: yes
    force: yes

# 2. Ensure acme.json exists for Traefik
- name: Create Traefik acme.json file with correct permissions
  ansible.builtin.file:
    path: "{{ app_dir }}/acme.json"
    state: touch
    mode: "0600"
    owner: root
    group: root

# 3. Clean up unused Docker resources
- name: Clean up unused Docker resources
  become: yes
  community.docker.docker_prune:
    containers: yes
    images: yes
    volumes: yes
    #networks: yes

# 4. Pull pre-built Docker images
- name: Pull pre-built Docker images for all services
  become: yes
  community.docker.docker_image:
    name: "{{ item }}"
    source: pull
  loop:
    - codedcoderrr/frontend:latest
    - codedcoderrr/auth:latest
    - codedcoderrr/todos:latest
    - codedcoderrr/users:latest
    - codedcoderrr/log-message-processor:latest

- name: Remove existing containers if they exist
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
    force_kill: yes # Stop and remove if running

  loop:
    - traefik
    - auth-api
    - todos-api
    - users-api
    - redis-queue
    - log-message-processor
    - frontend

# 5. Start/Restart services using docker-compose
- name: Start/Restart all services with docker-compose
  become: yes
  community.docker.docker_compose_v2:
    project_src: "{{ app_dir }}"
    state: present
    pull: missing # Pull from registry if not present
    build: never # NEVER build locally
    recreate: always # Always recreate containers to use latest images
