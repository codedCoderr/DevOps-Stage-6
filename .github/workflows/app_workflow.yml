name: ðŸš€ Application Deployment

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - "auth-api/**"
      - "todos-api/**"
      - "users-api/**"
      - "log-message-processor/**"
      - "docker-compose.yml"

jobs:
  deploy_app:
    runs-on: ubuntu-latest
    concurrency:
      group: deploy-app
      cancel-in-progress: true

    steps:
      # 1. Checkout code
      - uses: actions/checkout@v3

      # 2. Setup SSH key for Ansible
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ vars.SSH_PRIVATE_KEY_BASE64 }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Dynamically add hosts from inventory.ini to known_hosts
          INVENTORY_FILE=infra/inventory.ini
          for host in $(grep -vE '^\[|\s*#' $INVENTORY_FILE | awk '{print $1}'); do
            ssh-keyscan -H "$host" >> ~/.ssh/known_hosts || true
          done

      # 3. Run Ansible Deploy Playbook
      - name: Run Ansible Deploy
        working-directory: infra/terraform
        run: |
          ANSIBLE_HOST_KEY_CHECKING=False \
          ansible-playbook -i ../inventory.ini ../ansible/deploy.yml \
          --private-key ~/.ssh/id_rsa
